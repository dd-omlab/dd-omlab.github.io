% vrgbiasgen.m: generate an vrgbias file for vergence studies.% Written by: Jonathan Jacobs% Based on  : biasgen,edfbiasgen% Created   : 10 Nov 2020% % 23 Nov 2020: 1st test releasefunction vrgbiasgen(datname,dat_pn,sf,numrecs,chans,stsv)% Look for GUI.vcwin=findwind('Vergence Cal','name');if vcwin==-1   %returnelse      [dat_pn,~] = fileparts(vcwin.UserData.curr_sel_DD.Tag);   caldists = str2num(vcwin.UserData.caldistsStr.Value); %#ok<ST2NM>1   if isempty(caldists),caldists=[0 0];endendif ~exist('stsv','var'),stsv=0;endbiasfile = ['vrgbias_' datname '.txt'];cd(dat_pn)afilelist=dir('vrgbias_*');for i=1:length(afilelist)   if strcmpi( afilelist(i).name, biasfile )      disp( ['** The file ' biasfile ' already exists.'])      disp(  '** Do you want to replace it (y/n)?')      commandwindow      yorn=input('** -> ','s');      if strcmpi(yorn,'y')         delete(biasfile)         disp(['** ' biasfile ' will be replaced.'])         disp(' ')         break      else         return      end   endendNL=newline; oldpath = pwd;mstr = 'VID'; exten = '.bin'; %format = 'B';fstr = 'RAWBIN'; orgstr = 'Contiguous';sampfstr = num2str(sf(1));adjstr = [mat2str(caldists) '   ' mat2str(zeros(size(caldists)))];%chop off any trailing underscore for now. We will add it back when needed%stripped_uscore = 0;subjstr=datname;if subjstr(length(subjstr))=='_'   subjstr = subjstr(1:end-1);   %stripped_uscore = 1;endfid = fopen(['vrgbias_' datname,'.txt'],'wt');if fid == -1, disp('Yikes! Could not create that file!'); keyboard; enda = exist('time','file');if a == 2   dstr = [' on ' time('d',1,24,1)];   tstr = [' at ' time('t',1,24,1)];else   dstr = '';   tstr = '';endcommentstr1 = '% automagically generated by "vrgbiasgen"';commentstr2 = ['%' dstr tstr];fwrite(fid, [commentstr1 NL]);fwrite(fid, [commentstr2 NL]);fwrite(fid, NL);% now we can add the underscore back if needed.% subjstr = the edf recorded file name. So if the file was named with a% number at the end, an additional _1 is added, which is not what we want,% but I'm not sure how to fix it.% change so that any time there is more than 1 record,% there will be an underscore and number added% if (isdigit(subjstr(end)) || stripped_uscore == 1)  &&  numrecs>1if numrecs>1   add_num = 1;else   add_num = 0;endfor i = 1:numrecs   chan_count=length(chans{:});   if add_num      temp = [subjstr '_' num2str(i)];   else      temp = subjstr;   end   firstline = [temp  exten '  ' num2str(chan_count) '  '...      mstr '  ' fstr ' ' sampfstr ' ' orgstr  NL];   fwrite(fid,firstline);   for j = 1:chan_count      if stsv==1         chans{i}{end+1}='st';         chans{i}{end+1}='sv';      end      nextline = [chans{i}{j} '  ' adjstr NL];  % used to place 'sampfstr' here.      fwrite(fid, nextline);   end   fwrite(fid, NL);endfclose(fid);disp(['Vergence cal file written as ' biasfile]);disp('P.S.: Don''t panic if you think you messed up.')disp('You can manually edit it using any text editor,')disp('so you can tweak any values afterwards.')disp(' ')try   cd(oldpath)catchend